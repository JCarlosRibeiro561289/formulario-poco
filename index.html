<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Perfil Técnico do Poço</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 16px;
}

.step {
  display: none;
}
.step.active {
  display: block;
}

button {
  padding: 10px 16px;
  margin-top: 16px;
}

.erro-campo {
  border: 2px solid #e74c3c;
}

.erro-msg {
  color: #e74c3c;
  font-size: 12px;
  margin-top: 4px;
  display: block;
}

.filtro {
  border: 1px solid #ccc;
  padding: 8px;
  margin-top: 8px;
}

.filtro-header {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
}

.hidden {
  display: none;
}

pre {
  white-space: pre-wrap;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>

<!-- ================== ETAPA 0 ================== -->
<div class="step active">
  <h3>Cliente</h3>
  <input id="cliente" placeholder="Nome do cliente" />
  <button type="button" onclick="avancarEtapaAtual()">Avançar</button>
</div>

<!-- ================== ETAPA 1 ================== -->
<div class="step">
  <h3>Perfuração</h3>

  <input id="polInicial" placeholder="Ø Inicial" />
  <input id="polFinal" placeholder="Ø Final" />
  <input id="metrosInicial" placeholder="Metros iniciais" />
  <input id="profundidade" placeholder="Profundidade total" />

  <button type="button" onclick="prevStep()">Voltar</button>
  <button type="button" onclick="avancarEtapaAtual()">Avançar</button>
</div>

<!-- ================== ETAPA 2 ================== -->
<div class="step">
  <h3>Filtros</h3>

  <div id="listaFiltros"></div>

  <button type="button" onclick="addFiltro()">Adicionar Filtro</button>
  <div id="totalFiltros"></div>

  <button type="button" onclick="prevStep()">Voltar</button>
  <button type="button" onclick="avancarEtapaAtual()">Avançar</button>
</div>

<!-- ================== ETAPA 3 ================== -->
<div class="step">
  <h3>Resumo</h3>
  <div id="resumoConteudo"></div>

  <button type="button" onclick="exportarPDF()">Baixar PDF</button>
  <button type="button" onclick="enviarWhatsApp()">Enviar WhatsApp</button>
  <button type="button" onclick="prevStep()">Voltar</button>
</div>

<script>
let step = 0;
const steps = document.querySelectorAll(".step");

/* ================== ELEMENTOS ================== */
const cliente = document.getElementById("cliente");
const polInicial = document.getElementById("polInicial");
const polFinal = document.getElementById("polFinal");
const metrosInicial = document.getElementById("metrosInicial");
const profundidade = document.getElementById("profundidade");
const listaFiltros = document.getElementById("listaFiltros");
const resumoConteudo = document.getElementById("resumoConteudo");

/* ================== UTIL ================== */
function n(v) {
  if (!v) return 0;
  return parseFloat(v.toString().replace(",", ".")) || 0;
}

function f(v) {
  return n(v).toFixed(2).replace(".", ",");
}

/* ================== ERROS ================== */
function marcarErro(input, msg) {
  limparErros();
  input.classList.add("erro-campo");
  const span = document.createElement("span");
  span.className = "erro-msg";
  span.innerText = msg;
  input.parentNode.appendChild(span);
}

function limparErros() {
  document.querySelectorAll(".erro-msg").forEach(e => e.remove());
  document.querySelectorAll(".erro-campo").forEach(e => e.classList.remove("erro-campo"));
}

/* ================== STEPS ================== */
function showStep() {
  steps.forEach((s, i) => s.classList.toggle("active", i === step));
  if (step === 3) gerarResumoFinal();
}

function nextStep() {
  if (step < steps.length - 1) step++;
  showStep();
}

function prevStep() {
  if (step > 0) step--;
  showStep();
}

function avancarEtapaAtual() {
  limparErros();

  if (step === 0) {
    if (!cliente.value.trim()) {
      marcarErro(cliente, "Informe o cliente");
      return;
    }
  }

  if (step === 1) {
    const pi = n(polInicial.value);
    const pf = n(polFinal.value);
    const prof = n(profundidade.value);

    if (!pi || !pf || !prof) {
      marcarErro(polInicial, "Preencha a perfuração");
      return;
    }

    if (pf > pi) {
      marcarErro(polFinal, "Ø final maior que inicial");
      return;
    }
  }

  nextStep();
}

/* ================== FILTROS ================== */
function addFiltro() {
  const div = document.createElement("div");
  div.className = "filtro";

  div.innerHTML = `
    <div class="filtro-header">
      <span></span>
      <button type="button" onclick="this.closest('.filtro').remove(); atualizarTotalFiltros()">X</button>
    </div>
    <input class="de" placeholder="De (m)" onblur="this.value=f(this.value)" oninput="atualizarTotalFiltros()">
    <input class="ate" placeholder="Até (m)" onblur="this.value=f(this.value)" oninput="atualizarTotalFiltros()">
  `;

  listaFiltros.appendChild(div);
  atualizarTotalFiltros();
}

function atualizarTotalFiltros() {
  let total = 0;
  document.querySelectorAll(".filtro").forEach(f => {
    const de = n(f.querySelector(".de").value);
    const ate = n(f.querySelector(".ate").value);
    if (ate > de) total += (ate - de);
  });
  document.getElementById("totalFiltros").innerText =
    "Total filtrado: " + total.toFixed(2) + " m";
}

/* ================== LISOS ================== */
function gerarTrechosLisos() {
  const prof = n(profundidade.value);
  const filtros = [];

  document.querySelectorAll(".filtro").forEach(f => {
    filtros.push({
      de: n(f.querySelector(".de").value),
      ate: n(f.querySelector(".ate").value)
    });
  });

  filtros.sort((a, b) => a.de - b.de);

  const lisos = [];
  let inicio = 0;

  filtros.forEach(f => {
    if (f.de > inicio) lisos.push({ de: inicio, ate: f.de });
    inicio = f.ate;
  });

  if (inicio < prof) lisos.push({ de: inicio, ate: prof });

  return lisos;
}

/* ================== RESUMO ================== */
function gerarResumoFinal() {
  let txt = `PERFIL TÉCNICO DO POÇO\n\n`;
  txt += `Cliente: ${cliente.value}\n\n`;

  txt += `PERFURAÇÃO\n`;
  txt += `Ø Inicial: ${f(polInicial.value)}\n`;
  txt += `Ø Final: ${f(polFinal.value)}\n`;
  txt += `Profundidade: ${f(profundidade.value)} m\n\n`;

  txt += `FILTROS\n`;
  let total = 0;
  document.querySelectorAll(".filtro").forEach((filtro, i) => {
    const de = n(filtro.querySelector(".de").value);
    const ate = n(filtro.querySelector(".ate").value);
    total += Math.max(0, ate - de);
    txt += `Filtro ${i + 1}: ${f(de)} – ${f(ate)} m\n`;
  });

  txt += `\nTotal filtrado: ${total.toFixed(2)} m\n\n`;
  txt += `TRECHOS LISOS\n`;

  gerarTrechosLisos().forEach((l, i) => {
    txt += `Liso ${i + 1}: ${f(l.de)} – ${f(l.ate)} m\n`;
  });

  resumoConteudo.innerHTML = `<pre>${txt}</pre>`;
}

/* ================== PDF ================== */
function exportarPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const linhas = pdf.splitTextToSize(resumoConteudo.innerText, 180);
  pdf.setFont("courier");
  pdf.setFontSize(10);
  pdf.text(linhas, 10, 10);
  pdf.save("perfil-tecnico-poco.pdf");
}

/* ================== WHATSAPP ================== */
function enviarWhatsApp() {
  const texto = encodeURIComponent(resumoConteudo.innerText);
  window.open(`https://wa.me/?text=${texto}`, "_blank");
}
</script>

</body>
</html>
